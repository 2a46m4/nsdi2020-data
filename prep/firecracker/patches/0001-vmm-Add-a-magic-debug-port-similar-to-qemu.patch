From 4aa9f8467c657d9a92ffd24127bf631ee6b7ea2c Mon Sep 17 00:00:00 2001
From: Rolf Neugebauer <rn@rneugeba.io>
Date: Tue, 2 Apr 2019 20:27:57 +0100
Subject: [PATCH] vmm: Add a magic debug port similar to qemu

qemu has an optional debug port, defaulting to 0xf4 to
cause an immidiate exit from the VMM. Add this to firecracker

DO NOT MERGE THIS

Signed-off-by: Rolf Neugebauer <rn@rneugeba.io>
---
 vmm/src/lib.rs | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/vmm/src/lib.rs b/vmm/src/lib.rs
index 68bf385..e34b367 100644
--- a/vmm/src/lib.rs
+++ b/vmm/src/lib.rs
@@ -54,6 +54,7 @@ use std::fs::{metadata, File, OpenOptions};
 use std::io;
 use std::os::unix::io::{AsRawFd, RawFd};
 use std::path::PathBuf;
+use std::process;
 use std::result;
 use std::sync::atomic::{AtomicUsize, Ordering, ATOMIC_USIZE_INIT};
 use std::sync::mpsc::{channel, Receiver, Sender, TryRecvError};
@@ -106,6 +107,7 @@ use vstate::{Vcpu, Vm};
 /// - `i8042.dumbkbd` do not attempt to control kbd state via the i8042 (save boot time).
 const DEFAULT_KERNEL_CMDLINE: &str = "reboot=k panic=1 pci=off nomodules 8250.nr_uarts=0 \
                                       i8042.noaux i8042.nomux i8042.nopnp i8042.dumbkbd";
+const MAGIC_IOPORT_DEBUG_EXIT: u16 = 0x00f4;
 const MAGIC_IOPORT_SIGNAL_GUEST_BOOT_COMPLETE: u16 = 0x03f0;
 const MAGIC_VALUE_SIGNAL_GUEST_BOOT_COMPLETE: u8 = 123;
 const VCPU_RTSIG_OFFSET: i32 = 0;
@@ -1065,6 +1067,10 @@ impl Vmm {
                                         METRICS.vcpu.exit_io_in.inc();
                                     }
                                     VcpuExit::IoOut(addr, data) => {
+                                        if addr == MAGIC_IOPORT_DEBUG_EXIT
+                                        {
+                                            process::exit(0);
+                                        }
                                         if addr == MAGIC_IOPORT_SIGNAL_GUEST_BOOT_COMPLETE
                                             && data[0] == MAGIC_VALUE_SIGNAL_GUEST_BOOT_COMPLETE
                                         {
-- 
2.17.1

